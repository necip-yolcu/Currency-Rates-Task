name: Deploy to Coolify and Notify

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Trigger Coolify Deployment
        id: trigger
        run: |
          curl -s --request GET '${{ secrets.COOLIFY_WEBHOOK }}' \
          --header 'Authorization: Bearer ${{ secrets.COOLIFY_TOKEN }}'

      - name: Wait for Deployment to Finish
        id: wait
        run: |
          STATUS="running"

          echo "Waiting for Coolify deployment to finish..."

          while [ "$STATUS" = "running" ]; do

            sleep 15

            STATUS=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.COOLIFY_TOKEN }}" \
              https://ds-coolify.file.business/api/deployments | jq -r '.[0].status')

            echo "Current status: $STATUS"

          done

          echo "final_status=$STATUS" >> $GITHUB_OUTPUT

      - name: Notify Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          AUTHOR="${{ github.actor }}"
          RESULT="${{ steps.wait.outputs.final_status }}"

          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"ðŸš€ Deployment Finished\n\nCommit: $COMMIT_MSG\nAuthor: $AUTHOR\nResult: $RESULT\"
          }" \
          $SLACK_WEBHOOK_URL
